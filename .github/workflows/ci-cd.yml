name: Spring Boot CI/CD with SAST + SCA + DAST + Docker Hub (Port 10015)
on:
  push:
    branches: [ main ]
  workflow_dispatch:
env:
  APP_PORT: 10015
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/magic-bag-mono
  TARGET_URL: http://${{ secrets.EC2_HOST }}:10015

jobs:
  ci:
    name: Build, Test, SCA & SAST
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # ðŸ” SCA æ‰«æï¼ˆOWASP Dependency-Checkï¼‰
      - name: ðŸ” SCA - OWASP Dependency-Check (via Maven)
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -DskipTests=true \
            -Dproject.name="magic-bag-mono" \
            -DoutputDirectory="target/dependency-check-report" \
            -DfailOnCVSS=7 \
            -DcveValidForHours=24

      - name: Run tests & generate JaCoCo report
        run: mvn -B verify

      - name: ðŸ” SAST - SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.projectKey=leftover-blind-box-backend \
            -Dsonar.branch.name=main \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
            || echo "âš ï¸ Sonar scan completed but failed to validate default branch. Analysis still uploaded."

      - name: ðŸ“¤ Upload Unit Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-reports-${{ github.sha }}
          path: target/surefire-reports/
          retention-days: 30

      - name: ðŸ“¤ Upload JaCoCo Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-report-${{ github.sha }}
          path: target/site/jacoco/
          retention-days: 30

      - name: ðŸ“¤ Upload SCA (Dependency-Check) Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sca-report-${{ github.sha }}
          path: target/dependency-check-report/
          retention-days: 30

      - name: ðŸšª Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image (linux/amd64)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:latest

  deploy:
    name: Deploy to EC2
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¡ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # ç™»å½• Docker Hubï¼ˆæ‹‰å–ç§æœ‰é•œåƒéœ€è¦ï¼‰
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            # åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨
            docker stop magic-bag-mono || true
            docker rm magic-bag-mono || true
            # æ‹‰å–æœ€æ–°é•œåƒå¹¶è¿è¡Œ
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            docker run -d \
              --name magic-bag-mono \
              -p ${{ env.APP_PORT }}:${{ env.APP_PORT }} \
              ${{ env.DOCKER_IMAGE }}:latest

  dast:
    name: ZAP Security Scan
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: â³ Wait for application to start
        run: sleep 45
        if: ${{ !cancelled() }}

      - name: ðŸ” Validate and set target URL
        run: |
          EC2_HOST_CLEAN=$(echo "${{ secrets.EC2_HOST }}" | tr -d '[:space:]')
          if [ -z "$EC2_HOST_CLEAN" ]; then
            echo "âŒ Error: EC2_HOST secret is empty or invalid"
            exit 1
          fi
          TARGET_URL="http://${EC2_HOST_CLEAN}:${{ env.APP_PORT }}"
          if [[ ! "$TARGET_URL" =~ ^http[s]?:// ]]; then
            echo "âŒ Error: Invalid URL format - $TARGET_URL (must start with http:// or https://)"
            exit 1
          fi
          echo "TARGET_URL=$TARGET_URL" >> $GITHUB_ENV
          echo "âœ… Target URL set to: $TARGET_URL"

      - name: ðŸ” Check target service reachability
        run: |
          echo "Testing connectivity to $TARGET_URL..."
          if ! curl -Is --connect-timeout 10 "$TARGET_URL" >/dev/null 2>&1; then
            echo "âŒ Error: Target service is unreachable. Check:"
            echo "  - EC2_HOST: ${{ secrets.EC2_HOST }}"
            echo "  - Port ${{ env.APP_PORT }} in EC2 security group"
            echo "  - Application is running on the target"
            exit 1
          fi
          echo "âœ… Target service is reachable"

      - name: ðŸ•¸ï¸ Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.13.0
        with:
          target: ${{ env.TARGET_URL }}
          cmd_options: "-T 10 -m 5 -J zap_report.json -r report.html -d"

      - name: ðŸ” Analyze vulnerabilities
        if: always()
        run: |
          if [ ! -f "zap_report.json" ] || [ ! -f "report.html" ]; then
            echo "âŒ Error: ZAP report files not found. Scan may have failed."
            exit 1
          fi
          count=$(jq '
          [.site[]?.alerts[]? | select(.riskcode | tonumber >= 2)] | length
            ' zap_report.json)
          if [ "$count" -gt 0 ]; then
            echo -e "\nðŸš¨ Found $count high/critical vulnerabilities:"
            jq -r '
              .site[]?.alerts[]?
              | select(.riskcode | tonumber >= 2)
              | "â€¢ \(.name) (\(.riskdesc)): \(.url)"
              ' zap_report.json
            exit 1
          else
            echo -e "\nâœ… No high/critical vulnerabilities detected"
          fi

      - name: ðŸ“¤ Upload scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-report-${{ github.sha }}
          path: |
            report.html
            zap_report.json
          retention-days: 30