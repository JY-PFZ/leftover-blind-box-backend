name: DAST - OWASP ZAP Scan

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  APP_PORT: 10015
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/magic-bag-mono
  # ç§»é™¤é¢„å®šä¹‰çš„TARGET_URLï¼Œé¿å…ä¸ŽåŠ¨æ€è®¾ç½®å†²çª

jobs:
  dast:
    name: ZAP Security Scan
    runs-on: ubuntu-latest
    steps:
#      - name: â³ Wait for application to start
#        run: sleep 60  # æ¢å¤å¯åŠ¨ç­‰å¾…ï¼ˆæ ¹æ®æœåŠ¡å¯åŠ¨æ—¶é—´è°ƒæ•´ï¼Œå»ºè®®60ç§’ä»¥ä¸Šï¼‰
#        if: ${{ !cancelled() }}

      - name: ðŸ” Validate and set target URL
        run: |
          # æ¸…ç†EC2_HOSTä¸­çš„ç©ºç™½å­—ç¬¦ï¼Œé¿å…URLæ ¼å¼é”™è¯¯
          EC2_HOST_CLEAN=$(echo "${{ secrets.EC2_HOST }}" | tr -d '[:space:]')
          
          # æ£€æŸ¥EC2_HOSTæ˜¯å¦ä¸ºç©º
          if [ -z "$EC2_HOST_CLEAN" ]; then
            echo "âŒ Error: EC2_HOST secret is empty or invalid"
            exit 1
          fi
          
          # æž„å»ºå¹¶éªŒè¯ç›®æ ‡URLæ ¼å¼
          TARGET_URL="http://${EC2_HOST_CLEAN}:${{ env.APP_PORT }}"
          if [[ ! "$TARGET_URL" =~ ^http[s]?:// ]]; then
            echo "âŒ Error: Invalid URL format - $TARGET_URL (must start with http:// or https://)"
            exit 1
          fi
          
          echo "TARGET_URL=$TARGET_URL" >> $GITHUB_ENV
          echo "âœ… Target URL set to: $TARGET_URL"

      - name: ðŸ” Check target service reachability
        run: |
          echo "Testing connectivity to $TARGET_URL..."
          # æ£€æµ‹ç›®æ ‡ç«¯å£æ˜¯å¦å¯è¾¾ï¼ˆè¶…æ—¶10ç§’ï¼‰
          if ! curl -Is --connect-timeout 10 "$TARGET_URL" >/dev/null 2>&1; then
            echo "âŒ Error: Target service is unreachable. Check:"
            echo "  - EC2_HOST: ${{ secrets.EC2_HOST }}"
            echo "  - Port ${{ env.APP_PORT }} in EC2 security group"
            echo "  - Application is running on the target"
            exit 1
          fi
          echo "âœ… Target service is reachable"

      - name: ðŸ•¸ï¸ Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.13.0 # å‡çº§åˆ°æœ€æ–°ç¨³å®šç‰ˆ
        with:
          target: ${{ env.TARGET_URL }}
          # ä¿®æ­£å‚æ•°ï¼š-T è¡¨ç¤ºæ€»è¶…æ—¶ï¼ˆåˆ†é’Ÿï¼‰ï¼Œ-m è¡¨ç¤ºçˆ¬è™«æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
          cmd_options: "-T 10 -m 5 -J zap_report.json -r report.html -d"  # -då¯ç”¨è°ƒè¯•æ—¥å¿—
        continue-on-error: false  # æ‰«æå¤±è´¥æ—¶ç›´æŽ¥ç»ˆæ­¢ï¼ˆå¦‚éœ€å¿½ç•¥å¤±è´¥å¯è®¾ä¸ºtrueï¼‰

      - name: ðŸ” Analyze vulnerabilities
        if: always()  # å³ä½¿æ‰«æå¤±è´¥ä¹Ÿæ‰§è¡Œï¼ˆç”¨äºŽæ•èŽ·æŠ¥å‘Šç”Ÿæˆå¤±è´¥çš„æƒ…å†µï¼‰
        run: |
          # æ£€æŸ¥æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ ! -f "zap_report.json" ] || [ ! -f "report.html" ]; then
            echo "âŒ Error: ZAP report files not found. Scan may have failed."
            exit 1
          fi
          
          # æå–é«˜/ä¸¥é‡çº§åˆ«çš„æ¼æ´žï¼ˆriskcode 2=Highï¼Œ3=Criticalï¼‰
          high_or_critical=$(jq -r '
            .site[]?.alerts[]? 
            | select(.riskcode | tonumber >= 2) 
            | "â€¢ " + .name + " (" + .riskdesc + "): " + .url
          ' zap_report.json | grep -v "^$")
          
          count=$(echo "$high_or_critical" | wc -l)
          if [ "$count" -gt 0 ]; then
            echo -e "\nðŸš¨ Found $count high/critical vulnerabilities:"
            echo "$high_or_critical"
            exit 1
          else
            echo -e "\nâœ… No high/critical vulnerabilities detected"
          fi

      - name: ðŸ“¤ Upload scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-report-${{ github.sha }}
          path: |
            report.html
            zap_report.json
          retention-days: 30